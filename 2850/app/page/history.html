<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meal Planner - History</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            background: #f9fafb;
            transition: all 0.2s;
        }
        .item:hover {
            background: #f3f4f6;
            transform: translateY(-1px);
        }
        /* ---- Item themes by meal type ---- */
        /* Breakfast (Amber) */
        .item-breakfast{
          background:#fff7ed;           /* amber-50 */
          border-color:#fde68a;         /* amber-300 */
        }
        .item-breakfast:hover{ background:#ffedd5; }  /* amber-100 */

        /* Lunch (Emerald) */
        .item-lunch{
          background:#ecfdf5;           /* emerald-50 */
          border-color:#a7f3d0;         /* emerald-300 */
        }
        .item-lunch:hover{ background:#d1fae5; }      /* emerald-100 */

        /* Dinner (Purple) */
        .item-dinner{
          background:#faf5ff;           /* purple-50 */
          border-color:#d8b4fe;         /* purple-300 */
        }
        .item-dinner:hover{ background:#f3e8ff; }     /* purple-100 */

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 14px;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .btn-success {
            background-color: #10b981;
            color: white;
        }
        .btn-success:hover {
            background-color: #059669;
        }
        .filter-bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:16px}
        .filter-btn{
        padding:8px 14px;border-radius:999px;font-weight:700;font-size:12px;
        background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;cursor:pointer;transition:.15s;
        }
        .filter-btn:hover{background:#e0e7ff}
        .filter-btn.active{background:#3b82f6;color:#fff;border-color:#2563eb;box-shadow:0 0 0 3px rgba(59,130,246,.25)}
        .filter-chip{display:inline-flex;align-items:center;padding:2px 10px;border-radius:999px;background:#f3f4f6;font-size:12px}
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        /* Breakfast = Amber */
        .badge-breakfast {
          background-color: #fef3c7;  /* amber-100 */
          color: #92400e;             /* amber-800 */
        }

        /* Lunch = Emerald (xanh lá) */
        .badge-lunch {
          background-color: #dcfce7;  /* emerald-100 */
          color: #065f46;             /* emerald-800 */
        }

        /* Dinner = Purple (tím) */
        .badge-dinner {
          background-color: #f3e8ff;  /* purple-100 */
          color: #6b21a8;             /* purple-800 */
        }

        .hidden {
            display: none;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 24px;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .tab:hover {
            color: #3b82f6;
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }
        .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            margin: 2% auto;
            padding: 0;
            border-radius: 20px;
            width: 95%;
            max-width: 1200px;
            max-height: 95vh;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 32px;
            border-radius: 20px 20px 0 0;
        }
        .modal-body {
            padding: 32px;
            max-height: calc(95vh - 120px);
            overflow-y: auto;
        }
        .collapsible-section {
            background: white;
            border-radius: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        .collapsible-header {
            padding: 20px 24px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
            border-bottom: 1px solid #e5e7eb;
        }
        .collapsible-header:hover {
            background-color: #f9fafb;
        }
        .collapsible-content {
            padding: 24px;
            transition: all 0.3s ease;
        }
        .toggle-icon {
            display: inline-block;
            transition: transform 0.3s ease;
            font-size: 1rem;
            color: #6b7280;
        }
        .toggle-icon.rotated {
            transform: rotate(90deg);
        }
        .dish-collapsible {
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }
        .dish-header {
            padding: 16px 20px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
            border-bottom: 1px solid #e2e8f0;
        }
        .dish-header:hover {
            background-color: #f1f5f9;
        }
        .dish-content {
            padding: 20px;
            background: white;
            transition: all 0.3s ease;
        }
        .ingredient-tag {
            display: inline-block;
            background: #e0e7ff;
            color: #3730a3;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            margin: 2px;
        }
        .step-item {
            background: white;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-left: 3px solid #10b981;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .role-badge {
            display: inline-block;
            background: #fef3c7;
            color: #92400e;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .chef-badge {
            background: #dcfce7;
            color: #166534;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .info-item {
            background: #f1f5f9;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }
        .info-label {
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 4px;
        }
        .info-value {
            font-size: 1.125rem;
            color: #1e293b;
            font-weight: 600;
        }
        .comment-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        .comment-display {
            background: white;
            border-radius: 8px;
            padding: 16px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 16px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
        }
        .comment-input-area {
            display: flex;
            gap: 8px;
        }
        .comment-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        .regenerate-section {
            background: #fef3c7;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .progress-text {
            margin-top: 12px;
            font-size: 14px;
            color: #4b5563;
        }
        .tag-newest{
          display:inline-block;
          margin-left:6px;
          padding:2px 6px;
          border-radius:999px;
          background:yellow;     /* emerald-100 */
          color:red;           /* emerald-800 */
          font-size:10px;
          font-weight:800;
          letter-spacing:.04em;
          vertical-align:middle;
        }

    </style>
</head>
<body>
    <div class="min-h-screen py-8">
        <div class="max-w-6xl mx-auto px-4">
            <!-- Header -->
            <div class="text-center mb-8 fade-in">
                <h1 class="text-4xl font-bold text-white mb-4">📚 History</h1>
                <p class="text-xl text-blue-100">View your submissions and meal plans</p>
            </div>

            <!-- Tabs -->
            <div class="section fade-in">
<!--                <div class="tabs">-->
<!--                    <div class="tab" data-tab="plans">-->
<!--                        Meal Plans-->
<!--                    </div>-->

<!--                    <div class="tab active" data-tab="submissions">-->
<!--                        My Submissions-->
<!--                    </div>-->
<!--                </div>-->
                <!-- Plans Tab -->
                <div id="plansTab" class="tab-content ">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Meal Plans</h2>
                    <!-- Quick Filter -->
                    <div class="filter-bar" id="quickFilters">
                      <input type="date" id="quickDate" class="px-3 py-2 rounded-md border border-gray-300 text-sm" />
                      <button id="btnBreakfast" class="filter-btn" data-type="breakfast">BREAKFAST</button>
                      <button id="btnLunch" class="filter-btn" data-type="lunch">LUNCH</button>
                      <button id="btnDinner" class="filter-btn" data-type="dinner">DINNER</button>
                      <button id="btnClearFilters" class="btn btn-secondary !px-3 !py-2 !text-sm">Clear</button>
                      <span id="filterSummary" class="text-sm text-gray-500 ml-2"></span>
                    </div>

                    <div id="plansList" class="space-y-2">
                        <!-- Plans will be loaded here -->
                    </div>
                </div>

                <!-- Submissions Tab -->
                <div id="submissionsTab" class="tab-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Submissions</h2>
                    <div id="submissionsList" class="space-y-2">
                        <!-- Submissions will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Back Button -->
            <div class="text-center">
                <button id="backBtn" class="btn btn-secondary">
                    Back to Home
                </button>
            </div>
        </div>
    </div>

    <!-- Plan Details Modal -->
    <div id="planDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold mb-2">🍽️ Meal Plan Details</h2>
                        <p class="text-blue-100" id="planTitle">Loading...</p>
                    </div>
                    <button id="closeModalBtn" class="text-white hover:text-blue-200 text-3xl font-bold transition-colors">
                        ×
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <div id="planDetailsContent">
                    <!-- Plan details will be loaded here -->
                </div>
                
                <!-- Comment Section -->
                <div class="comment-section">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">💬 Comments & Feedback</h3>
                    <div id="commentDisplay" class="comment-display">
                        No comments yet.
                    </div>
                    <div class="comment-input-area">
                        <input 
                            type="text" 
                            id="commentInput" 
                            class="comment-input" 
                            placeholder="Add your comment (e.g., need more dishes, adjust servings, add specific items...)"
                        />
                        <button id="addCommentBtn" class="btn btn-primary">
                            Add Comment
                        </button>
                    </div>
                </div>

                <!-- Regenerate Section -->
                <div class="regenerate-section">
                    <h3 class="text-xl font-bold text-gray-800 mb-3">🔄 Regenerate Plan</h3>
                    <p class="text-sm text-gray-600 mb-4">
                        Click to regenerate this plan based on the comments above. 
                        GPT will adjust the plan according to your feedback.
                    </p>
                    <div id="regenerateContent">
                        <button id="regenerateBtn" class="btn btn-success" style="padding: 12px 32px; font-size: 16px;">
                            Regenerate Plan with Feedback
                        </button>
                    </div>
                    <div id="regenerateProgress" class="hidden">
                        <div class="loading-spinner"></div>
                        <p class="progress-text">Regenerating plan based on your feedback...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/notifications.js"></script>
    <script>
        
        let currentUser = null;
        let submissions = [];
        let plans = [];
        let currentPlanId = null;
        let userFamilies = [];

        // --- Quick Filter state ---
        let filterDate = null;                 // 'YYYY-MM-DD' hoặc null
        let filterTypes = new Set();           // {'breakfast','lunch','dinner'}

        const normDate = (v) => (v ? String(v).slice(0,10) : '');
        function updateFilterButtonsUI(){
          ['breakfast','lunch','dinner'].forEach(t=>{
            const btn = document.querySelector(`.filter-bar [data-type="${t}"]`);
            if (!btn) return;
            btn.classList.toggle('active', filterTypes.has(t));
            btn.setAttribute('aria-pressed', filterTypes.has(t) ? 'true' : 'false');
          });
        }
        function updateFilterSummary(){
          const chips = [];
          if (filterDate) chips.push(`<span class="filter-chip">📅 ${filterDate}</span>`);
          filterTypes.forEach(t=>chips.push(`<span class="filter-chip">${t.toUpperCase()}</span>`));
          const sum = document.getElementById('filterSummary');
          if (sum) sum.innerHTML = chips.join(' ');
        }
        function getFilteredPlans(){
          let list = [...plans];
          if (filterDate){
            list = list.filter(p => normDate(p.meal_date) === filterDate);
          }
          if (filterTypes.size > 0){
            list = list.filter(p => filterTypes.has(String(p.meal_type||'').toLowerCase()));
          }
          return list;
        }

        // --- sanitation helpers ---
        function sanitizeHTML(str) {
            if (str === null || str === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(str);
            return div.innerHTML; // escaped <>&"' an toàn
        }
        function safeUrl(url) {
            if (!url || typeof url !== 'string') return '';
            const trimmed = url.trim();
            // chỉ cho phép https://
            if (/^https:\/\/[a-z0-9\-._~:/?#\[\]@!$&'()*+,;=%]+$/i.test(trimmed)) {
                return trimmed;
            }
            return '';
        }
        const s = sanitizeHTML;
        const u = safeUrl;

        function videoHref(dish) {
          const v = safeUrl(dish && dish.video_url);
          if (v) return v;
          const name = (dish && dish.name || '').trim();
          return name ? `https://www.youtube.com/results?search_query=${encodeURIComponent(name)}` : '';
        }

          // Tạo slug từ tên món để map sang ảnh tĩnh trong /page/images/dishes/
          // function slugifyDishName(v) {
          //   return String(v || "")
          //     .toLowerCase()
          //     .normalize('NFD').replace(/[\u0300-\u036f]/g, '')   // bỏ dấu
          //     .replace(/[^a-z0-9]+/g, '-')                       // non-alnum -> '-'
          //     .replace(/(^-|-$)/g, '');
          // }

        function directDishUrl(dish) {
          const v = (dish && typeof dish.image_url === 'string') ? dish.image_url.trim() : '';
          return /^https:\/\//i.test(v) ? v : '';
        }

        async function getAutoDishImage(name) {
          // dùng đường dẫn tuyệt đối để tránh 404 tương đối khi mở file ở base khác
          const PLACEHOLDER = 'images/dishes/placeholder.jpg';
          if (!name) return PLACEHOLDER;

          if (!window.API_BASE) await window.API_READY;
          const BASE = window.API_BASE; // '/api' khi same-origin

          try {
            const r = await fetch(`${BASE}/images/dish?name=${encodeURIComponent(name)}`, { cache: 'no-store' });
            if (r.ok) {
              const js = await r.json();
              if (js && js.src) return js.src;  // có thể là '/page/images/...' hoặc URL https
            }
          } catch (_) {
            // bỏ qua lỗi, rơi về placeholder
          }
          return PLACEHOLDER;
        }


        // --- helper: parse JSON an toàn (nếu backend trả plan_json/preferences là string) ---
        function parseMaybeJson(x) {
            if (x == null) return x;
            if (typeof x === 'string') {
                try { return JSON.parse(x); } catch { return x; }
            }
            return x;
        }

        // Chuẩn hoá cấu trúc plan_json về 1 object có fields: dishes, meta...
        function extractPlanData(raw) {
          const peel = (x) => {
            if (!x) return x;
            if (x.plan) x = x.plan;
            if (x.data) x = x.data;
            if (x.meal_plan) x = x.meal_plan;
            if (x.plan_json) x = x.plan_json;
            return x;
          };

          let x = parseMaybeJson(raw);
          x = peel(x);
          x = parseMaybeJson(x);
          x = peel(x);

          if (Array.isArray(x)) x = x[0] || null;
          return (x && typeof x === 'object') ? x : null;
        }

        // Initialize page
        window.addEventListener('load', async () => {
            // Đợi auth.js dò API_BASE xong
            if (!window.API_BASE) await window.API_READY;
            // Use auth.js for proper authentication
            initAuth(
                async (user) => {
                    currentUser = user;
                    
                    // Load user families for permission checking
                    await loadUserFamilies();
                    
                    // Start notification checking
                    if (window.NotificationSystem) {
                        window.NotificationSystem.start(user.user_id);
                    }
                    
                    setupEventListeners();
                    attachFilterEvents();
                    await loadData();
                    
                    // Check URL parameters
                    const urlParams = new URLSearchParams(window.location.search);
                    const tab = urlParams.get('tab');
                    const planId = urlParams.get('planId');

                    // Switch to specified tab
                    if (tab === 'plans') {
                      switchTab('plans');

                      // Auto open plan details if planId is specified
                      if (planId) {
                        setTimeout(() => {
                          const p = plans.find(p => String(p.id) === String(planId));
                          viewPlanDetails(parseInt(planId), p ? p.family_id : null);
                        }, 500);
                      }
                    } else {
                      // ✅ Mặc định mở Meal Plans nếu không có ?tab=...
                      switchTab('plans');
                    }
                },
                () => {
                    window.location.href = 'index.html';
                }
            );
        });

        // Load user families for permission checking
        async function loadUserFamilies() {
            try {
                if (!window.API_BASE) await window.API_READY;
                const BASE = window.API_BASE;
                const response = await fetch(
                  `${BASE}/user/${encodeURIComponent(currentUser.user_id)}/families`,
                  { cache: 'no-store' }
                );
                if (response.ok) {
                    userFamilies = await response.json();
                    localStorage.setItem('userFamilies', JSON.stringify(userFamilies));
                }
            } catch (error) {
                console.error('Error loading user families:', error);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    switchTab(e.target.dataset.tab);
                });
            });

            // Back button
            document.getElementById('backBtn').addEventListener('click', () => {
                window.location.href = 'home.html';
            });

            // Modal close
            document.getElementById('closeModalBtn').addEventListener('click', () => {
                document.getElementById('planDetailsModal').classList.remove('show');
            });

            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                const modal = document.getElementById('planDetailsModal');
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });

            // Add comment button
            document.getElementById('addCommentBtn').addEventListener('click', addComment);

            // Regenerate button
            document.getElementById('regenerateBtn').addEventListener('click', regeneratePlan);
        }

        function attachFilterEvents(){
          const dateEl = document.getElementById('quickDate');
          if (dateEl){
            dateEl.addEventListener('change', (e)=>{
              filterDate = e.target.value || null;
              updateFilterSummary();
              displayPlans(); // re-render
            });
          }
          ['btnBreakfast','btnLunch','btnDinner'].forEach(id=>{
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('click', ()=>{
              const t = (el.dataset.type||'').toLowerCase();
              if (!t) return;
              if (filterTypes.has(t)) filterTypes.delete(t); else filterTypes.add(t);
              updateFilterButtonsUI();
              updateFilterSummary();
              displayPlans();
            });
          });
          const clearEl = document.getElementById('btnClearFilters');
          if (clearEl){
            clearEl.addEventListener('click', ()=>{
              filterDate = null;
              filterTypes.clear();
              const dateEl = document.getElementById('quickDate');
              if (dateEl) dateEl.value = '';
              updateFilterButtonsUI();
              updateFilterSummary();
              displayPlans();
            });
          }
          // init UI
          updateFilterButtonsUI();
          updateFilterSummary();
        }

        function switchTab(tabName) {
          // Bỏ qua nếu không có thanh Tabs
          const tabs = document.querySelectorAll('.tab');
          if (tabs.length) {
            tabs.forEach(t => t.classList.remove('active'));
            const act = document.querySelector(`[data-tab="${tabName}"]`);
            if (act) act.classList.add('active');
          }
          // Show/hide nội dung
          const hasSubs = document.getElementById('submissionsTab');
          const hasPlans = document.getElementById('plansTab');
          if (hasSubs) hasSubs.classList.toggle('hidden', tabName !== 'submissions');
          if (hasPlans) hasPlans.classList.toggle('hidden', tabName !== 'plans');
        }


        // Load all data
        async function loadData() {
            await Promise.all([
                loadSubmissions(),
                loadPlans()
            ]);
        }

        // Load user submissions
        async function loadSubmissions() {
            try {
                if (!window.API_BASE) await window.API_READY;
                const BASE = window.API_BASE;
                const response = await fetch(
                  `${BASE}/submissions/my?family_id=all&user_id=${encodeURIComponent(currentUser.user_id)}&limit=100`,
                  { cache: 'no-store' }
                );
                if (response.ok) {
                    submissions = await response.json();
                    displaySubmissions();
                } else {
                    console.error('Failed to load submissions');
                }
            } catch (error) {
                console.error('Error loading submissions:', error);
            }
        }

        // Load meal plans
        async function loadPlans() {
            try {
                if (!window.API_BASE) await window.API_READY;
                const BASE = window.API_BASE;
                const allPlans = [];

                // 1) Kế thừa logic cũ: thử lấy theo meal_code trong submissions của user
                //    (nếu backend đã retire, đoạn này sẽ quietly bỏ qua)
                try {
                    const userSubmissionsResponse = await fetch(
                        `${BASE}/submissions/my?family_id=all&user_id=${encodeURIComponent(currentUser.user_id)}&limit=100`,
                        { cache: 'no-store' }
                    );
                    if (userSubmissionsResponse.ok) {
                        const userSubmissions = await userSubmissionsResponse.json();
                        const userMealCodes = [...new Set(
                            userSubmissions.map(sub => sub.meal_code).filter(code => code)
                        )];

                        for (const mealCode of userMealCodes) {
                            try {
                                const plansResponse = await fetch(`${BASE}/plan/meal-code/${encodeURIComponent(mealCode)}`, { cache: 'no-store' });
                                if (plansResponse.ok) {
                                    const mealCodePlans = await plansResponse.json();
                                    allPlans.push(...mealCodePlans);
                                } else {
                                    // endpoint có thể 410/404 sau khi retire → bỏ qua, không alert
                                    // console.debug('meal-code lookup skipped:', mealCode, plansResponse.status);
                                }
                            } catch (_) {
                                // bỏ qua lỗi đơn lẻ, vẫn tiếp tục phần family
                            }
                        }
                    }
                } catch (_) {
                    // bỏ qua lỗi lớp ngoài của block meal_code
                }

                // 2) Lấy theo các family user đang tham gia (phần cũ của bạn)
                const familiesResponse = await fetch(`${BASE}/user/${encodeURIComponent(currentUser.user_id)}/families`, { cache: 'no-store' });
                 if (familiesResponse.ok) {
                   const families = await familiesResponse.json();
                   try {
                     const familyPlanPromises = families.map(f =>
                       fetch(`${BASE}/plan/family/${encodeURIComponent(f.family_id)}?with_json=1`, { cache: 'no-store' })
                         .then(r => r.ok ? r.json() : [])
                         .catch(() => [])
                     );
                     const familyPlansArrays = await Promise.all(familyPlanPromises);
                     familyPlansArrays.forEach(arr => allPlans.push(...arr));
                   } catch (_) {}
                 }

                // dedupe theo id (giữ code cũ)
                const uniquePlans = allPlans.filter((plan, index, self) =>
                  index === self.findIndex(p => String(p.id) === String(plan.id))
                );
                plans = uniquePlans;
                displayPlans();

            } catch (error) {
                console.error('Error loading plans:', error);
            }
        }

        // Display submissions
        function displaySubmissions() {
            const container = document.getElementById('submissionsList');
            container.innerHTML = '';

            if (submissions.length === 0) {
                container.innerHTML = '<p class="text-gray-500 italic">No submissions found</p>';
                return;
            }

            // Sort by creation date (newest first)
            submissions.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            submissions.forEach(submission => {
                const item = document.createElement('div');

                const mealDate = new Date(submission.meal_date);
                const mealType = submission.meal_type || 'Unknown';
                const themeClass = getItemThemeClass(mealType);
                const badgeClass = getBadgeClass(mealType);

                item.className = `item ${themeClass}`;

                const roleLabel =
                  (submission.user_id === currentUser.user_id && isHolder(submission.family_id))
                    ? 'holder'
                    : (submission.role || 'member');

                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <span class="badge ${badgeClass}">${mealType}</span>
                                <span class="text-sm text-gray-500">${mealDate.toLocaleDateString()}</span>
                            </div>
                            <p class="font-semibold text-gray-800">Family: ${s(submission.family_name || submission.family_id)}</p>
                            <p class="text-sm text-gray-600">Submitted: ${new Date(submission.created_at).toLocaleString()}</p>
                            <p class="text-sm text-gray-600">Role: ${s(roleLabel)} (${s(submission.display_name)})</p>

                            ${submission.remark ? `<p class="text-sm text-blue-600 mt-1">"${s(submission.remark)}"</p>` : ''}
                        </div>
                        <div class="flex space-x-2">
                            <button class="btn btn-primary" onclick="viewSubmissionDetails('${submission.id}')">
                                Details
                            </button>
                            <button class="btn btn-success" onclick="resubmitSubmission('${submission.id}')">
                                Resubmit
                            </button>
                            <button class="btn btn-danger" onclick="deleteSubmission(${submission.id})">
                                🗑️ Delete
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // Display plans
        function displayPlans() {
          const container = document.getElementById('plansList');
          container.innerHTML = '';

          if (plans.length === 0) {
            container.innerHTML = '<p class="text-gray-500 italic">No meal plans found</p>';
            return;
          }

          // Lấy danh sách đã lọc, rồi sort theo created_at (newest first).
          // Dùng fallback -Infinity để an toàn nếu thiếu created_at.
          const list = getFilteredPlans().sort((a, b) => {
            const ta = a && a.created_at ? Date.parse(a.created_at) : -Infinity;
            const tb = b && b.created_at ? Date.parse(b.created_at) : -Infinity;
            return tb - ta;
          });

          if (list.length === 0) {
            container.innerHTML = '<p class="text-gray-500 italic">No plans match current filters</p>';
            return;
          }

          // ID của item đầu tiên trong danh sách hiện tại (NEWEST)
          const newestId = (list[0] && list[0].id) || null;

          list.forEach(plan => {
            const item = document.createElement('div');

            const mealDate = new Date(plan.meal_date);
            const mealType = plan.meal_type || 'Unknown';
            const themeClass = getItemThemeClass(mealType);
            const badgeClass = getBadgeClass(mealType);

            item.className = `item ${themeClass}`;

            const isHolderFlag = isHolder(plan.family_id);

            item.innerHTML = `
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <div class="flex items-center space-x-3 mb-2">
                    <span class="badge ${badgeClass}">${mealType.toUpperCase()}</span>
                    <span class="text-sm text-gray-500">${mealDate.toLocaleDateString()}</span>
                    ${String(plan.id) === String(newestId) ? '<span class="tag-newest">NEWEST</span>' : ''}
                  </div>
                  <p class="font-semibold text-gray-800">Family: ${s(plan.family_id)}</p>
                  <p class="text-sm text-gray-600">Plan Code: ${s(plan.plan_code)}</p>
                  <p class="text-sm text-gray-600">Generated: ${new Date(plan.created_at).toLocaleString()}</p>
                </div>
                <div class="flex space-x-2">
                  <button class="btn btn-primary" onclick="viewPlanDetails(${plan.id}, '${plan.family_id}')">View Details</button>
                  ${isHolderFlag ? `<button class="btn btn-danger" onclick="deletePlan(${plan.id}, '${plan.family_id}')">🗑️ Delete</button>` : ''}
                </div>
              </div>
            `;
            container.appendChild(item);
          });
        }



        function getBadgeClass(mealType) {
          const mt = (mealType || '').toString().toLowerCase();
          switch (mt) {
            case 'breakfast': return 'badge-breakfast';
            case 'lunch':     return 'badge-lunch';
            case 'dinner':    return 'badge-dinner';
            default:          return 'badge-lunch'; // hoặc badge trung tính nếu bạn muốn
          }
        }

        function getItemThemeClass(mealType){
          const mt = (mealType || '').toString().toLowerCase();
          if (mt === 'breakfast') return 'item-breakfast';
          if (mt === 'lunch')     return 'item-lunch';
          if (mt === 'dinner')    return 'item-dinner';
          return ''; // fallback: dùng nền xám mặc định của .item
        }

        // View submission details
        function viewSubmissionDetails(submissionId) {
            const submission = submissions.find(s => s.id == submissionId);
            if (submission) {
                const roleLabel =
                  (submission.user_id === currentUser.user_id && isHolder(submission.family_id))
                    ? 'holder'
                    : (submission.role || 'member');
                // Create a modal for better display
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-gray-800">📋 Submission Details</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-3xl font-bold">&times;</button>
                        </div>
                        
                        <!-- Basic Information Section -->
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6 mb-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="mr-2">👤</span> Basic Information
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-white rounded-lg p-4 shadow-sm">
                                    <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">User Name</p>
                                    <p class="text-lg font-semibold text-gray-800 mt-1">${s(submission.display_name || submission.user_id)}</p>
                                </div>
                                <div class="bg-white rounded-lg p-4 shadow-sm">
                                    <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">Role</p>
                                    <p class="text-lg font-semibold text-gray-800 mt-1">${s(roleLabel)}</p>
                                </div>
                                <div class="bg-white rounded-lg p-4 shadow-sm">
                                    <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">Family</p>
                                    <p class="text-lg font-semibold text-gray-800 mt-1">${s(submission.family_name || submission.family_id)}</p>
                                </div>
                                <div class="bg-white rounded-lg p-4 shadow-sm">
                                    <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">Age</p>
                                    <p class="text-lg font-semibold text-gray-800 mt-1">${submission.age || 'Not specified'}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Meal Information Section -->
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-6 mb-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="mr-2">🍽️</span> Meal Information
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="bg-white rounded-lg p-4 shadow-sm">
                                    <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">Meal Date</p>
                                    <p class="text-lg font-semibold text-gray-800 mt-1">${new Date(submission.meal_date).toLocaleDateString()}</p>
                                </div>
                                <div class="bg-white rounded-lg p-4 shadow-sm">
                                    <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">Meal Type</p>
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium mt-1 ${getMealTypeBadgeClass(submission.meal_type)}">
                                        ${submission.meal_type}
                                    </span>
                                </div>
                                <div class="bg-white rounded-lg p-4 shadow-sm">
                                    <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">Submitted</p>
                                    <p class="text-lg font-semibold text-gray-800 mt-1">${new Date(submission.created_at).toLocaleString()}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Preferences Section -->
                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-6 mb-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="mr-2">⚙️</span> Preferences & Settings
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                ${renderPreferences(parseMaybeJson(submission.preferences))}
                            </div>
                        </div>

                        <!-- Additional Information -->
                        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg p-6 mb-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="mr-2">📝</span> Additional Information
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-white rounded-lg p-4 shadow-sm">
                                    <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">Drinks</p>
                                    <p class="text-lg font-semibold text-gray-800 mt-1">${s(submission.drinks || 'None specified')}</p>
                                </div>
                                <div class="bg-white rounded-lg p-4 shadow-sm">
                                    <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">Remark</p>
                                    <p class="text-lg font-semibold text-gray-800 mt-1">${s(submission.remark || 'No remarks')}</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end mt-6">
                            <button onclick="this.closest('.fixed').remove()" class="btn btn-secondary px-8 py-3 text-lg">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
        }

        function getMealTypeBadgeClass(mealType) {
          switch ((mealType || '').toLowerCase()) {
            case 'breakfast': return 'bg-yellow-100 text-yellow-800';    // giữ vàng
            case 'lunch':     return 'bg-emerald-100 text-emerald-800';  // xanh lá
            case 'dinner':    return 'bg-purple-100 text-purple-800';    // tím
            default:          return 'bg-gray-100 text-gray-800';
          }
        }

        // Helper function to render preferences in a user-friendly way
        function renderPreferences(preferences) {
            if (!preferences || typeof preferences !== 'object') {
                return '<div class="col-span-2"><p class="text-gray-500 italic">No preferences specified</p></div>';
            }

            let html = '';
            
            // Chef status
            if (preferences.is_chef !== undefined) {
                html += `
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">Chef Status</p>
                        <div class="mt-2">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${preferences.is_chef ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                ${preferences.is_chef ? '👨‍🍳 Yes, I can cook' : '🍽️ No, I prefer not to cook'}
                            </span>
                        </div>
                    </div>
                `;
            }

            // Food style
            if (preferences.food_style) {
                html += `
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">Food Style</p>
                        <p class="text-lg font-semibold text-gray-800 mt-1 capitalize">${preferences.food_style}</p>
                    </div>
                `;
            }

            // Allergies
            if (preferences.allergies) {
                html += `
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">Allergies</p>
                        <p class="text-lg font-semibold text-red-600 mt-1">⚠️ ${preferences.allergies}</p>
                    </div>
                `;
            }

            // Liked tastes
            if (preferences.liked_tastes && preferences.liked_tastes.length > 0) {
                html += `
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">Liked Tastes</p>
                        <div class="mt-2 flex flex-wrap gap-2">
                            ${preferences.liked_tastes.map(taste => 
                                `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                                    👍 ${taste}
                                </span>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }

            // Disliked tastes
            if (preferences.disliked_tastes && preferences.disliked_tastes.length > 0) {
                html += `
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">Disliked Tastes</p>
                        <div class="mt-2 flex flex-wrap gap-2">
                            ${preferences.disliked_tastes.map(taste => 
                                `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
                                    👎 ${taste}
                                </span>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }

            // Tasks
            if (preferences.before_task && preferences.before_task !== 'none') {
                html += `
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">Before Meal Task</p>
                        <p class="text-lg font-semibold text-gray-800 mt-1">${preferences.before_task}</p>
                    </div>
                `;
            }

            if (preferences.after_task && preferences.after_task !== 'none') {
                html += `
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">After Meal Task</p>
                        <p class="text-lg font-semibold text-gray-800 mt-1">${preferences.after_task}</p>
                    </div>
                `;
            }

            return html || '<div class="col-span-2"><p class="text-gray-500 italic">No detailed preferences specified</p></div>';
        }

        // Resubmit submission
        function resubmitSubmission(submissionId) {
            const confirmResubmit = confirm('Are you sure you want to resubmit this submission? This will overwrite the existing submission.');
            if (confirmResubmit) {
                // Navigate to submission page with pre-filled data for resubmission
                window.location.href = `submission.html?resubmit=${submissionId}`;
            }
        }

        // Check if current user is holder of a family
        function isHolder(familyId) {
            if (!currentUser || !currentUser.user_id) return false;
            const family = userFamilies.find(f => f.family_id === familyId);
            return family && family.role === 'holder';
        }

        // Delete plan (only holder can delete)
        async function deletePlan(planId, familyId) {
            if (!isHolder(familyId)) {
                alert('您没有删除权限。只有家庭创建者(holder)可以删除计划。');
                return;
            }

            if (!confirm('Are you sure you want to delete this plan? This action cannot be undone.')) {
                return;
            }

            try {
                if (!window.API_BASE) await window.API_READY;
                const BASE = window.API_BASE;
                const response = await fetch(`${BASE}/plan/${encodeURIComponent(planId)}?user_id=${encodeURIComponent(currentUser.user_id)}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Plan deleted successfully!');
                    // Reload plans
                    await loadPlans();
                } else {
                    const error = await response.json();
                    alert('Failed to delete plan: ' + (error.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting plan:', error);
                alert('Error deleting plan: ' + error.message);
            }
        }

        // Delete submission (user can delete their own)
        async function deleteSubmission(submissionId) {
            if (!confirm('Are you sure you want to delete this submission? This action cannot be undone.')) {
                return;
            }

            try {
                if (!window.API_BASE) await window.API_READY;
                const BASE = window.API_BASE;
                const response = await fetch(`${BASE}/submissions/${encodeURIComponent(submissionId)}?user_id=${encodeURIComponent(currentUser.user_id)}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Submission deleted successfully!');
                    // Reload submissions
                    await loadSubmissions();
                } else {
                    const error = await response.json();
                    alert('Failed to delete submission: ' + (error.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting submission:', error);
                alert('Error deleting submission: ' + error.message);
            }
        }

        // View plan details
        async function viewPlanDetails(planId, familyId = null) {
          try {
            currentPlanId = planId;

            // 1) ưu tiên dùng dữ liệu đã có trong mảng plans
            let planDetails = plans.find(p => String(p.id) === String(planId));

            // 2) nếu chưa có (hoặc thiếu plan_json), thử lấy lại list theo family rồi lọc
            if ((!planDetails || !planDetails.plan_json) && familyId) {
              if (!window.API_BASE) await window.API_READY;
              const BASE = window.API_BASE;
              const resp = await fetch(`${BASE}/plan/family/${encodeURIComponent(familyId)}?with_json=1`, { cache: 'no-store' });
              if (resp.ok) {
                const arr = await resp.json();
                const found = arr.find(p => String(p.id) === String(planId));
                if (found) planDetails = found;
              }
            }

            if (!planDetails) {
              alert('Plan not found or not accessible.');
              return;
            }

            let submissionsAt = [];
            try {
              if (!window.API_BASE) await window.API_READY;
              const BASE = window.API_BASE;
              const respSubs = await fetch(
                `${BASE}/submissions/family/${encodeURIComponent(planDetails.family_id)}/at?meal_date=${encodeURIComponent(planDetails.meal_date)}`,
                { cache: 'no-store' }
              );
              if (respSubs.ok) {
                const all = await respSubs.json();
                submissionsAt = all.filter(r =>
                  String(r.meal_type || '').toLowerCase() === String(planDetails.meal_type || '').toLowerCase()
                );
              }
            } catch (_) {}

            // --- load family preferences (all members with saved pref) ---
            let familyPrefs = [];
            try {
              if (!window.API_BASE) await window.API_READY;
              const BASE = window.API_BASE;
              const respPrefs = await fetch(
                `${BASE}/preferences/family/${encodeURIComponent(planDetails.family_id)}`,
                { cache: 'no-store' }
              );
              if (respPrefs.ok) {
                familyPrefs = await respPrefs.json(); // [{ user_id, user_name, display_name, role, preference, pref_saved_at... }, ...]
              }
            } catch (_) {
              // keep familyPrefs = []
            }

            // Lọc preferences THEO NGÀY ĂN của plan (meal_date) + meal_type
            const mealDayStr = (planDetails.meal_date || '').slice(0, 10);
            const mealTypeLc = String(planDetails.meal_type || '').toLowerCase();
            const famIdLc    = String(planDetails.family_id || '').trim().toLowerCase();

            // timestamp của ngày ăn (cuối ngày để "≤" dễ so sánh)
            const mealTs = mealDayStr ? Date.parse(mealDayStr + 'T23:59:59') : Number.POSITIVE_INFINITY;

            // Gom theo user_id và chọn bản phù hợp nhất cho ngày ăn
            const latestByUid = new Map();

            (familyPrefs || []).forEach(m => {
              const uid  = (m.user_id != null) ? String(m.user_id).trim() : '';
              const name = (m.display_name || m.user_name || '').toString().trim();
              if (!uid || !name) return;

              // ❗ GIỮ HOLDER, chỉ loại "giả người" nếu KHÔNG phải holder
              const roleLc = String(m.role || '').toLowerCase();
              const isFakeById   = (uid.toLowerCase()  === famIdLc) && roleLc !== 'holder';
              const isFakeByName = (name.toLowerCase() === famIdLc) && roleLc !== 'holder';
              if (isFakeById || isFakeByName) return;

              const pref = parseMaybeJson(m.preference) || {};

              // chỉ nhận người thật sự đã chọn role/task
              const tasksOk  = Array.isArray(pref.tasks) && pref.tasks.length > 0;
              const beforeOk = pref.before_task && String(pref.before_task).toLowerCase() !== 'none';
              const afterOk  = pref.after_task  && String(pref.after_task ).toLowerCase() !== 'none';
              if (!(pref.is_chef || tasksOk || beforeOk || afterOk)) return;

              // meal_type phải khớp (nếu pref có)
              const prefTypeLc = String(pref.meal_type || pref.type || '').toLowerCase();
              if (prefTypeLc && prefTypeLc !== mealTypeLc) return;

              // Ưu tiên pref có gắn đúng meal_date; nếu không có thì lấy bản mới nhất ≤ meal_date
              const prefDay   = (pref.meal_date || pref.date || '').toString().slice(0, 10);
              const exactDate = !!(prefDay && mealDayStr && prefDay === mealDayStr);

              const tsStr = (m.pref_saved_at || m.updated_at || m.updatedAt || m.created_at || m.saved_at || '').toString();
              const ts    = tsStr ? Date.parse(tsStr) : Number.NEGATIVE_INFINITY;

              // Nếu không có prefDay, dùng saved_at ≤ meal_date (nếu meal_date có)
              if (!exactDate) {
                if (mealTs !== Number.POSITIVE_INFINITY && !(ts <= mealTs)) return;
              }

              // Chọn record tốt hơn theo thứ tự: exactDate ưu tiên > timestamp mới hơn
              const prev = latestByUid.get(uid);
              if (!prev) {
                latestByUid.set(uid, { ...m, __pref: pref, __ts: ts, __exact: exactDate });
              } else {
                const better =
                  (exactDate && !prev.__exact) ||
                  (exactDate === prev.__exact && ts >= prev.__ts);
                if (better) latestByUid.set(uid, { ...m, __pref: pref, __ts: ts, __exact: exactDate });
              }
            });

            const familyPrefsForPlan = Array.from(latestByUid.values())
              .map(x => ({ ...x, preference: x.__pref })); // chuẩn hoá field preference

            // Render dùng danh sách đã lọc theo meal_date
            displayPlanDetails(planDetails, [], familyPrefsForPlan);

            const regenerateSection = document.querySelector('.regenerate-section');
            if (regenerateSection) {
              if (isHolder(planDetails.family_id)) {
                regenerateSection.style.display = 'block';
              } else {
                regenerateSection.style.display = 'none';
              }
            }

            document.getElementById('planDetailsModal').classList.add('show');
          } catch (error) {
            console.error('Error loading plan details:', error);
            alert('Error loading plan details: ' + error.message);
          }
        }


        // --- map task code -> label gọn gàng
function toTaskLabel(x) {
  if (!x || x === 'none') return null;
  // chuẩn hoá vài key phổ biến
  const map = {
    'pre_work': 'Pre Work (Shopping & Prep)',
    'after_work': 'After Work (Cleanup)',
    'cooking': 'Cooking',
    'cook': 'Cooking'
  };
  const key = String(x).toLowerCase().replace(/\s+/g,'_');
  return map[key] || x;
}

// xác định một người có "chọn preference" hay chưa
function hasChosenPref(p) {
  if (!p || typeof p !== 'object') return false;
  if (p.is_chef) return true;
  // trước/sau khác 'none'
  if (p.before_task && String(p.before_task).toLowerCase() !== 'none') return true;
  if (p.after_task  && String(p.after_task ).toLowerCase() !== 'none') return true;
  // hoặc có tasks mảng
  if (Array.isArray(p.tasks) && p.tasks.length > 0) return true;
  return false;
}

// --- trả về mảng roles từ plan_json, chịu được nhiều cấu trúc
function normalizeRoles(planData) {
  const meta = planData?.meta || {};
  let roles = [];

  // 1) Ưu tiên meta.roles (chuẩn mới)
  if (Array.isArray(meta.roles)) roles = meta.roles;

  // 2) Thử các biến thể thường gặp
  if (roles.length === 0 && Array.isArray(planData.roles)) roles = planData.roles;
  if (roles.length === 0 && Array.isArray(meta.participants)) roles = meta.participants;
  if (roles.length === 0 && Array.isArray(planData.participants)) roles = planData.participants;

  // 3) Nếu là object map -> convert sang array
  if (roles.length === 0 && meta.roles && typeof meta.roles === 'object') {
    roles = Object.values(meta.roles);
  }

  return roles;
}

// --- tạo nhãn role hiển thị trên badge (Chef + Before/After)
function roleLabels(role) {
  const labels = [];
  if (role.is_chef) labels.push('Chef');
  const b = toTaskLabel(role.before_task);
  const a = toTaskLabel(role.after_task);
  if (b) labels.push(b);
  if (a) labels.push(a);
  return labels; // không ép "Member", không dùng person_role ở đây
}

function hasMeaningfulPref(p) {
  if (!p || typeof p !== 'object') return false;
  if (p.is_chef) return true;
  if (Array.isArray(p.tasks) && p.tasks.length) return true;
  const bt = (p.before_task || '').toLowerCase();
  const at = (p.after_task || '').toLowerCase();
  return (bt && bt !== 'none') || (at && at !== 'none');
}

async function displayPlanDetails(plan, submissionsAt = [], familyPrefs = []) {
  // --- header ---
  const planTitle = document.getElementById('planTitle');
  planTitle.textContent = `${(plan.meal_type || 'MEAL').toUpperCase()} - ${plan.meal_date}`;

  const commentDisplay = document.getElementById('commentDisplay');
  commentDisplay.textContent = plan.comment || 'No comments yet.';

  let content = '';

  // --- overview ---
  content += `
    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleSection('overview')">
        <div class="flex items-center justify-between w-full">
          <div class="flex items-center gap-3">
            <span class="toggle-icon" id="overview-icon">▼</span>
            <h3 class="text-xl font-bold text-gray-800">📋 Plan Overview</h3>
          </div>
          <div class="flex space-x-2">
            <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
              ${s(plan.plan_code || 'N/A')}
            </span>
          </div>
        </div>
      </div>
      <div class="collapsible-content" id="overview-content">
        <div class="info-grid">
          <div class="info-item"><div class="info-label">📅 Date</div><div class="info-value">${s(plan.meal_date || 'N/A')}</div></div>
          <div class="info-item"><div class="info-label">🍽️ Meal Type</div><div class="info-value">${(plan.meal_type || 'N/A').toUpperCase()}</div></div>
          <div class="info-item"><div class="info-label">👥 Family</div><div class="info-value">${s(plan.family_id || 'N/A')}</div></div>
          <div class="info-item"><div class="info-label">🕒 Created</div><div class="info-value">${new Date(plan.created_at).toLocaleDateString()}</div></div>
        </div>
      </div>
    </div>
  `;

  // --- parse plan_json an toàn ---
  const planData = extractPlanData(plan.plan_json) || {};

  // Build a map from submissions: key = display_name or user_id (lowercased)
     const prefByKey = new Map();
     (submissionsAt || []).forEach(sub => {
       const prefs = parseMaybeJson(sub.preferences) || {};
       const nameKey = (sub.display_name || '').trim().toLowerCase();
       const uidKey  = (sub.user_id || '').trim().toLowerCase();
       if (nameKey) prefByKey.set(`name:${nameKey}`, prefs);
       if (uidKey)  prefByKey.set(`uid:${uidKey}`,  prefs);
     });

     // --- map from familyPrefs (gồm tất cả members trong family) ---
    (familyPrefs || []).forEach(m => {
      const prefs = parseMaybeJson(m.preference) || {};
      const nameKey = (m.display_name || m.user_name || '').trim().toLowerCase();
      const uidKey  = (m.user_id || '').toString().trim().toLowerCase();
      if (nameKey) {
        // chỉ set nếu chưa có từ submissions (giữ ưu tiên submission-of-the-day)
        const k = `name:${nameKey}`;
        if (!prefByKey.has(k)) prefByKey.set(k, prefs);
      }
      if (uidKey) {
        const k = `uid:${uidKey}`;
        if (!prefByKey.has(k)) prefByKey.set(k, prefs);
      }
    });


  // ===== helpers cho Participants =====
  // const toTaskLabel = (x) => {
  //   if (!x || String(x).toLowerCase() === 'none') return null;
  //   const k = String(x).toLowerCase().replace(/\s+/g, '_');
  //   const map = {
  //     pre_work: 'Pre Work (Shopping & Prep)',
  //     before: 'Pre Work (Shopping & Prep)',
  //     before_work: 'Pre Work (Shopping & Prep)',
  //     after_work: 'After Work (Cleanup)',
  //     cleanup: 'After Work (Cleanup)',
  //     cooking: 'Cooking',
  //     cook: 'Cooking',
  //   };
  //   return map[k] || x;
  // };

  const isVirtualName = (name) => {
    const n = (name || '').trim().toLowerCase();
    if (!n) return true;
    return ['wheel/ai', 'wheel ai', 'ai', 'system', 'bot'].includes(n);
  };

    // Trích người dùng từ nhiều nguồn, CHỈ giữ ai có preference đã chọn
    function deriveParticipants(pd, familyPrefs, submissionsAt, familyId) {
      const out = [];

      function _hasChosenPref(p) {
        if (!p || typeof p !== 'object') return false;
        const tasksOk  = Array.isArray(p.tasks) && p.tasks.length > 0;
        const beforeOk = p.before_task && String(p.before_task).toLowerCase() !== 'none';
        const afterOk  = p.after_task  && String(p.after_task ).toLowerCase() !== 'none';
        return !!(p.is_chef || tasksOk || beforeOk || afterOk);
      }

      function _toTaskLabel(x) {
        if (!x || x === 'none') return null;
        const map = {
          'pre_work':  'Pre Work (Shopping & Prep)',
          'after_work':'After Work (Cleanup)',
          'cooking':   'Cooking',
          'cook':      'Cooking'
        };
        const key = String(x).toLowerCase().replace(/\s+/g,'_');
        return map[key] || x;
      }

      function _prettyName(member) {
        const rawDisplay = (member.display_name || '').toString().trim();
        const userName   = (member.user_name   || '').toString().trim();

        // Heuristic: tên auto kiểu Dav12345 (chữ + ≥3 số liền sau) → ưu tiên user_name
        if (/^[A-Za-z_]+[0-9]{3,}$/.test(rawDisplay)) {
          return userName || rawDisplay;
        }
        return rawDisplay || userName;
      }

      function pushFromPref(member) {
        const uid = (member && member.user_id != null) ? String(member.user_id).trim() : '';
        if (!uid) return;

        // Giữ holder ngay cả khi uid === familyId; chỉ chặn user ảo không role
        const fam = (familyId != null) ? String(familyId).trim() : '';
        const roleLc = String(member.role || '').toLowerCase();
        if (fam && uid.toLowerCase() === fam.toLowerCase() && roleLc !== 'holder') {
          return; // loại user ảo trùng family_id nếu không phải holder
        }

        const displayName = _prettyName(member);
        if (!displayName) return; // không tên → bỏ

        const pref = parseMaybeJson(member.preference) || {};
        if (!_hasChosenPref(pref)) return;

        const base = {
          _uid: uid,
          user_id: uid,
          name: displayName,
          person_role: member.role, // 'holder' / 'member'
          role: member.role,
          is_chef: !!pref.is_chef,
          before_task: pref.before_task,
          after_task:  pref.after_task,
          tasks: Array.isArray(pref.tasks) ? pref.tasks.slice() : (function () {
            const t = [];
            if (pref.before_task && String(pref.before_task).toLowerCase() !== 'none') t.push('pre_work');
            if (pref.after_task  && String(pref.after_task ).toLowerCase() !== 'none') t.push('after_work');
            return t;
          })(),
          age_group: pref.age_group
        };

        base.tasks = (base.tasks || []).map(_toTaskLabel).filter(Boolean);
        out.push(base);
      }

      // CHỈ dựa trên familyPrefs (đã được lọc chuẩn ở viewPlanDetails)
      (familyPrefs || []).forEach(pushFromPref);

      // De-dup theo user_id
      const byUid = new Map();
      out.forEach(p => {
        const key = String(p.user_id || '').trim().toLowerCase();
        if (!key) return;
        const existed = byUid.get(key);
        if (!existed) {
          byUid.set(key, p);
        } else {
          // merge nhẹ
          if ((!existed.tasks || existed.tasks.length === 0) && p.tasks && p.tasks.length) {
            existed.tasks = p.tasks.slice();
          }
          if (!existed.is_chef && p.is_chef) existed.is_chef = true;
          if (!existed.person_role && p.person_role) existed.person_role = p.person_role;
          if (!existed.age_group && p.age_group) existed.age_group = p.age_group;
        }
      });

      return Array.from(byUid.values());
    }

  if (planData && (planData.dishes || planData.meta)) {
    // ===== Participants & Cooking Preferences =====
    const participants = deriveParticipants(planData, familyPrefs, submissionsAt, plan.family_id);

    if (participants.length > 0) {
      content += `
        <div class="collapsible-section">
          <div class="collapsible-header" onclick="toggleSection('participants')">
            <div class="flex items-center gap-3">
<!--              <span class="toggle-icon" id="participid: String(id || name),ants-icon">▼</span>-->

                 <span class="toggle-icon" id="participants-icon">▼</span>

              <h3 class="text-xl font-bold text-gray-800">👥 Participants & Roles (${participants.length})</h3>
            </div>
          </div>
          <div class="collapsible-content" id="participants-content">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      `;

      participants.forEach(p => {
          // Nhãn vai trò theo preference (Chef / Pre / After)
          const labels = roleLabels(p);

          // Badge membership: Holder hoặc Member (mặc định Member)
          const isHolderRole = (p.person_role || '').toString().toLowerCase() === 'holder';
          const membershipBadge = isHolderRole ? 'Holder' : 'Member';

          // Tasks hiển thị bằng nhãn đẹp
          const taskLabels = Array.isArray(p.tasks)
            ? p.tasks.map(toTaskLabel).filter(Boolean)
            : [];
        content += `
          <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
            <div class="flex items-center justify-between mb-2">
              <h4 class="font-semibold text-gray-800">${s(p.name)}</h4>
              <div class="flex flex-wrap gap-2">
                <span class="role-badge">${membershipBadge}</span>

              </div>
            </div>
            <div class="text-sm text-gray-600">
              ${labels.length
                ? `<p><strong>Role (preferences):</strong> ${labels.map(s).join(' • ')}</p>`
                : `<p class="text-gray-400 italic">No preference role</p>`
              }
              ${p.age_group ? `<p><strong>Age Group:</strong> ${s(p.age_group)}</p>` : ''}
            </div>
          </div>
        `;
      });

      content += `</div></div></div>`;
    }

    // ===== Dishes =====
    if (Array.isArray(planData.dishes) && planData.dishes.length > 0) {
      content += `
        <div class="collapsible-section">
          <div class="collapsible-header" onclick="toggleSection('dishes')">
            <div class="flex items-center gap-3">
              <span class="toggle-icon" id="dishes-icon">▼</span>
              <h3 class="text-xl font-bold text-gray-800">🍽️ Menu & Recipes (${planData.dishes.length} dishes)</h3>
            </div>
          </div>
          <div class="collapsible-content" id="dishes-content">
            <div class="space-y-3">
      `;
      planData.dishes.forEach((dish, index) => {
        content += `
          <div class="dish-collapsible">
            <div class="dish-header" onclick="toggleDish('dish-${index}')">
              <div class="flex items-center justify-between w-full">
                <div class="flex items-center gap-3">
                  <span class="toggle-icon" id="dish-${index}-icon">▶</span>
                  <h4 class="text-lg font-bold text-gray-800">${s(dish.name || 'Unnamed Dish')}</h4>
                  <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-medium">
                    ${s(dish.category || 'Main Course')}
                  </span>
                </div>
                <div class="flex items-center gap-3">
                  ${videoHref(dish) ? `
                    <a href="${videoHref(dish)}" target="_blank"
                       class="text-red-600 hover:text-red-800 text-sm font-medium flex items-center gap-1"
                       onclick="event.stopPropagation()">🎥 Video</a>` : ''}
                  <span class="text-sm text-gray-500">Recipe #${index + 1}</span>
                </div>
              </div>
            </div>
            <div class="dish-content" id="dish-${index}-content" style="display: none;">
        `;

        content += `
            <img
              id="dish-img-${index}"
              data-dish-name="${s(dish.name || '')}"
              data-direct-url="${directDishUrl(dish)}"
              src="/page/images/dishes/placeholder.jpg"
              alt="${s(dish.name || 'Dish image')}"
              class="w-full max-w-md h-48 object-cover rounded-xl border mx-auto dish-img-lazy"
              loading="lazy"
              onerror="this.onerror=null; this.src='/page/images/dishes/placeholder.jpg'"
            />
        `;

        if (Array.isArray(dish.ingredients) && dish.ingredients.length > 0) {
          content += `
            <div class="mb-4">
              <h5 class="font-semibold text-gray-700 mb-3 flex items-center">🥘 Ingredients</h5>
              <div class="flex flex-wrap gap-2">
          `;
          dish.ingredients.forEach(ing => {
            const amount = ing.amount ? ` ${s(ing.amount)}${s(ing.unit || '')}` : '';
            content += `<span class="ingredient-tag">${s(ing.name || '')}${amount}</span>`;
          });
          content += `</div></div>`;
        }

        if (Array.isArray(dish.steps) && dish.steps.length > 0) {
          content += `
            <div class="mb-4">
              <h5 class="font-semibold text-gray-700 mb-3 flex items-center">👨‍🍳 Cooking Instructions</h5>
              <div class="space-y-2">
          `;
          dish.steps.forEach((step, stepIndex) => {
            const stepText = typeof step === 'object' ? (step.description || '') : String(step || '');
            const safeTime = step.time ? ` (${s(step.time)})` : '';
            content += `
              <div class="step-item">
                <div class="flex items-start">
                  <span class="flex-shrink-0 w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3 mt-0.5">${stepIndex + 1}</span>
                  <div>
                    <p class="text-gray-700">${s(stepText)}</p>
                    ${safeTime ? `<span class="text-sm text-green-600 font-medium">${safeTime}</span>` : ''}
                  </div>
                </div>
              </div>
            `;
          });
          content += `</div></div>`;
        }

        content += `</div></div>`;
      });
      content += `</div></div></div>`;
    }

    // // ===== Summary =====
    // content += `
    //   <div class="collapsible-section bg-gradient-to-r from-blue-50 to-purple-50">
    //     <div class="collapsible-header" onclick="toggleSection('summary')">
    //       <div class="flex items-center gap-3">
    //         <span class="toggle-icon" id="summary-icon">▼</span>
    //         <h3 class="text-xl font-bold text-gray-800">📊 Plan Summary</h3>
    //       </div>
    //     </div>
    //     <div class="collapsible-content" id="summary-content">
    //       <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    //         <div class="text-center"><div class="text-2xl font-bold text-blue-600">${Number(planData.meta?.headcount || participants?.length || 0)}</div><div class="text-sm text-gray-600">Total People</div></div>
    //         <div class="text-center"><div class="text-2xl font-bold text-green-600">${Number(planData.dishes?.length || 0)}</div><div class="text-sm text-gray-600">Dishes</div></div>
    //         <div class="text-center"><div class="text-2xl font-bold text-purple-600">${s(planData.meta?.Time || 'N/A')}</div><div class="text-sm text-gray-600">Meal Time</div></div>
    //       </div>
    //     </div>
    //   </div>
    // `;
  } else {
    // ---- fallback khi không có chi tiết plan_json ----
    content += `
      <div class="plan-card text-center py-12">
        <div class="text-6xl mb-4">📝</div>
        <h3 class="text-xl font-semibold text-gray-600 mb-2">No Detailed Plan Available</h3>
        <p class="text-gray-500">This plan doesn't contain detailed recipe information.</p>
      </div>
    `;
  }

  document.getElementById('planDetailsContent').innerHTML = content;

  await resolveDishImages(document.getElementById('planDetailsContent'));

  // // Lazy-load ảnh món ăn sau khi DOM đã render
  //   (async function lazyLoadDishImages() {
  //     const nodes = document.querySelectorAll('#planDetailsContent img.dish-img-lazy');
  //     for (const img of nodes) {
  //       const direct = (img.dataset.direct || '').trim();
  //       if (/^https:\/\//i.test(direct)) {
  //         img.src = direct;                 // nếu plan đã có link ảnh trực tiếp -> dùng luôn
  //         continue;
  //       }
  //       const name = img.dataset.dishName || '';
  //       img.src = await getAutoDishImage(name);  // gọi API backend để tự tìm + cache
  //     }
  //   })();

}


        // Toggle collapsible section
        function toggleSection(sectionId) {
            const content = document.getElementById(`${sectionId}-content`);
            const icon = document.getElementById(`${sectionId}-icon`);

            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '▼';
                icon.classList.remove('rotated');
            } else {
                content.style.display = 'none';
                icon.textContent = '▶';
                icon.classList.add('rotated');
            }
        }

        // Toggle individual dish
        function toggleDish(dishId) {
            const content = document.getElementById(`${dishId}-content`);
            const icon = document.getElementById(`${dishId}-icon`);

            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '▼';
                icon.classList.remove('rotated');
            } else {
                content.style.display = 'none';
                icon.textContent = '▶';
                icon.classList.add('rotated');
            }
        }

        // Add comment
        async function addComment() {
            const commentInput = document.getElementById('commentInput');
            const commentText = commentInput.value.trim();

            if (!commentText) {
                alert('Please enter a comment');
                return;
            }

            if (!currentPlanId) {
                alert('No plan selected');
                return;
            }

            try {
                if (!window.API_BASE) await window.API_READY;
                const BASE = window.API_BASE;
                const response = await fetch(`${BASE}/plan/${encodeURIComponent(currentPlanId)}/comment?user_name=${encodeURIComponent(currentUser.user_name)}&comment_text=${encodeURIComponent(commentText)}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('commentDisplay').textContent = result.comment;
                    commentInput.value = '';
                    alert('Comment added successfully!');
                } else {
                    const error = await response.json();
                    alert('Failed to add comment: ' + (error.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error adding comment:', error);
                alert('Error adding comment: ' + error.message);
            }
        }

        // Regenerate plan
        async function regeneratePlan() {
            if (!currentPlanId) {
                alert('No plan selected');
                return;
            }

            // Get current plan's family_id to check if user is holder
            const currentPlan = plans.find(p => p.id === currentPlanId);
            if (!currentPlan) {
                alert('Plan not found');
                return;
            }

            // Check if user is holder
            if (!isHolder(currentPlan.family_id)) {
                alert('您没有权限重新生成此计划。只有家庭创建者(holder)可以重新生成计划。');
                return;
            }

            if (!confirm('Are you sure you want to regenerate this plan based on the comments? This will create a new plan.')) {
                return;
            }

            try {
                // Show progress
                document.getElementById('regenerateContent').classList.add('hidden');
                document.getElementById('regenerateProgress').classList.remove('hidden');

                if (!window.API_BASE) await window.API_READY;
                const BASE = window.API_BASE;
                const response = await fetch(`${BASE}/plan/${encodeURIComponent(currentPlanId)}/regenerate?user_id=${encodeURIComponent(currentUser.user_id)}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Plan regenerated successfully!');

                    // Close modal and redirect to new plan
                    document.getElementById('planDetailsModal').classList.remove('show');
                    window.location.href = `history.html?tab=plans&planId=${result.plan_id}`;
                } else {
                    const error = await response.json();
                    alert('Failed to regenerate plan: ' + (error.detail || 'Unknown error'));

                    // Hide progress and show button again
                    document.getElementById('regenerateContent').classList.remove('hidden');
                    document.getElementById('regenerateProgress').classList.add('hidden');
                }
            } catch (error) {
                console.error('Error regenerating plan:', error);
                alert('Error regenerating plan: ' + error.message);

                // Hide progress and show button again
                document.getElementById('regenerateContent').classList.remove('hidden');
                document.getElementById('regenerateProgress').classList.add('hidden');
            }
        }

        async function resolveDishImages(root) {
          const imgs = root.querySelectorAll('img[id^="dish-img-"]');
          for (const img of imgs) {
            const direct = (img.dataset.directUrl || '').trim();
            if (direct) { img.src = direct; continue; }

            const name = (img.dataset.dishName || '').trim();
            if (!name) continue;

            if (!window.API_BASE) await window.API_READY;
            const BASE = window.API_BASE; // ví dụ http://127.0.0.1:8765/api

            try {
              const r = await fetch(`${BASE}/images/dish?name=${encodeURIComponent(name)}`, { cache: 'no-store' });
              if (r.ok) {
                const { src } = await r.json();
                if (src) img.src = src;   // đổi từ placeholder sang ảnh thật
              }
            } catch (e) {
              // giữ nguyên placeholder nếu lỗi mạng
            }
          }
        }

    </script>
</body>
</html>
